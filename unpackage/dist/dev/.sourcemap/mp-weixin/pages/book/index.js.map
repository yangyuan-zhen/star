{"version":3,"file":"index.js","sources":["pages/book/index.vue","../../../../360极速浏览器下载/HBuilderX.4.29.2024093009/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvYm9vay9pbmRleC52dWU"],"sourcesContent":["<template>\r\n  <view class=\"book-container\">\r\n    <view class=\"search-box\">\r\n      <input\r\n        class=\"search-input\"\r\n        v-model=\"bookName\"\r\n        placeholder=\"请输入书名\"\r\n        @confirm=\"handleSearch\"\r\n      />\r\n      <button class=\"search-btn\" @tap=\"handleSearch\" :disabled=\"loading\">\r\n        {{ loading ? \"生成中...\" : \"生成\" }}\r\n      </button>\r\n    </view>\r\n    <text class=\"tip-text\"\r\n      >AI荐书，智能推荐好书，为你提供专业的推荐理由和精彩内容概述，帮你快速找到心仪的书籍！</text\r\n    >\r\n\r\n    <view class=\"result-box\" v-if=\"imageUrl\">\r\n      <image\r\n        class=\"result-image\"\r\n        :src=\"imageUrl\"\r\n        mode=\"widthFix\"\r\n        lazy-load\r\n        :style=\"{ opacity: imageLoaded ? 1 : 0 }\"\r\n        @load=\"handleImageLoad\"\r\n        @error=\"handleImageError\"\r\n      />\r\n      <button class=\"action-btn save-btn\" @tap=\"handleSaveImage\">\r\n        保存图片\r\n      </button>\r\n    </view>\r\n  </view>\r\n  <canvas\r\n    type=\"2d\"\r\n    canvas-id=\"saveCanvas\"\r\n    style=\"position: fixed; left: -9999px; width: 300px; height: 300px\"\r\n  ></canvas>\r\n</template>\r\n\r\n<script setup>\r\nimport { ref } from \"vue\";\r\nimport { getBookRecommend } from \"@/api/search.js\";\r\nimport { onShareAppMessage, onShareTimeline } from \"@dcloudio/uni-app\";\r\n\r\nconst bookName = ref(\"\");\r\nconst imageUrl = ref(\"\");\r\nconst loading = ref(false);\r\nconst imageLoaded = ref(false);\r\n\r\nconst handleSearch = async () => {\r\n  if (!bookName.value.trim()) {\r\n    uni.showToast({\r\n      title: \"请输入书名\",\r\n      icon: \"none\",\r\n    });\r\n    return;\r\n  }\r\n\r\n  loading.value = true;\r\n  try {\r\n    const res = await getBookRecommend(bookName.value);\r\n    console.log(\"API返回结果:\", res);\r\n\r\n    // 如果返回的是错误信息\r\n    if (typeof res === \"string\" && res.includes(\"Error\")) {\r\n      throw new Error(\"服务请求失败，请稍后重试\");\r\n    }\r\n\r\n    // 直接尝试解析返回的数据\r\n    let imageData;\r\n    try {\r\n      imageData = typeof res === \"string\" ? JSON.parse(res) : res;\r\n      if (imageData.data) {\r\n        const parsedData = JSON.parse(imageData.data);\r\n        imageUrl.value = parsedData.output;\r\n      } else if (imageData.output) {\r\n        imageUrl.value = imageData.output;\r\n      } else {\r\n        throw new Error(\"未找到图片地址\");\r\n      }\r\n    } catch (parseError) {\r\n      console.error(\"数据解析错误:\", parseError);\r\n      throw new Error(\"数据格式错误\");\r\n    }\r\n  } catch (error) {\r\n    console.error(\"处理错误:\", error);\r\n    uni.showToast({\r\n      title: error.message || \"请求失败，请稍后重试\",\r\n      icon: \"none\",\r\n      duration: 2000,\r\n    });\r\n  } finally {\r\n    loading.value = false;\r\n  }\r\n};\r\n\r\nconst handleSaveImage = async () => {\r\n  try {\r\n    if (!imageUrl.value) {\r\n      throw new Error(\"图片地址不能为空\");\r\n    }\r\n\r\n    await uni.showLoading({ title: \"处理中...\" });\r\n\r\n    // 调用云函数下载图片\r\n    const callFunctionResult = await uniCloud.callFunction({\r\n      name: \"downloadImage\",\r\n      data: {\r\n        imageUrl: imageUrl.value,\r\n      },\r\n    });\r\n\r\n    console.log(\"云函数调用结果:\", callFunctionResult);\r\n\r\n    if (!callFunctionResult || !callFunctionResult.result) {\r\n      throw new Error(\"云函数返回结果为空\");\r\n    }\r\n\r\n    const result = callFunctionResult.result;\r\n    console.log(\"云函数返回数据:\", result);\r\n\r\n    if (result.code !== 0) {\r\n      throw new Error(result.msg || \"处理图片失败\");\r\n    }\r\n\r\n    // 检查权限\r\n    const settingRes = await uni.getSetting({});\r\n    if (!settingRes.authSetting[\"scope.writePhotosAlbum\"]) {\r\n      await uni.authorize({ scope: \"scope.writePhotosAlbum\" });\r\n    }\r\n\r\n    // 下载云存储的图片到本地\r\n    const downloadRes = await uni.downloadFile({\r\n      url: result.data.tempFileURL,\r\n    });\r\n\r\n    if (downloadRes.statusCode !== 200) {\r\n      throw new Error(\"下载图片失败\");\r\n    }\r\n\r\n    // 保存图片到相册\r\n    await uni.saveImageToPhotosAlbum({\r\n      filePath: downloadRes.tempFilePath,\r\n    });\r\n\r\n    uni.showToast({\r\n      title: \"保存成功\",\r\n      icon: \"success\",\r\n    });\r\n  } catch (error) {\r\n    console.error(\"保存失败:\", error);\r\n    uni.showToast({\r\n      title: error.message || \"保存失败\",\r\n      icon: \"none\",\r\n      duration: 3000,\r\n    });\r\n  } finally {\r\n    uni.hideLoading();\r\n  }\r\n};\r\n\r\nconst handleImageLoad = () => {\r\n  imageLoaded.value = true;\r\n  console.log(\"图片加载成功\");\r\n};\r\n\r\nconst handleImageError = async (retryCount = 0) => {\r\n  if (retryCount < 3) {\r\n    console.log(`图片加载失败，第${retryCount + 1}次重试`);\r\n    await new Promise((resolve) => setTimeout(resolve, 1000));\r\n    imageUrl.value = `${imageUrl.value}?retry=${retryCount}`;\r\n  } else {\r\n    console.error(\"图片加载失败\");\r\n    uni.showToast({\r\n      title: \"图片加载失败\",\r\n      icon: \"none\",\r\n    });\r\n  }\r\n};\r\n\r\nonShareAppMessage(() => {\r\n  return {\r\n    title: \"AI荐书\",\r\n    path: \"/pages/book/index\",\r\n    imageUrl: imageUrl.value,\r\n  };\r\n});\r\n\r\nonShareTimeline(() => {\r\n  return {\r\n    title: \"AI荐书\",\r\n    query: \"/pages/book/index\",\r\n    imageUrl: imageUrl.value,\r\n  };\r\n});\r\n</script>\r\n\r\n<style scoped lang=\"scss\">\r\n.book-container {\r\n  padding: 20rpx;\r\n  background-color: #f5f5f5;\r\n  min-height: 100vh;\r\n}\r\n\r\n.search-box {\r\n  display: flex;\r\n  gap: 20rpx;\r\n  padding: 20rpx;\r\n  background-color: #fff;\r\n  border-radius: 12rpx;\r\n}\r\n\r\n.search-input {\r\n  flex: 1;\r\n  height: 80rpx;\r\n  padding: 0 20rpx;\r\n  border: 2rpx solid #eee;\r\n  border-radius: 8rpx;\r\n  font-size: 28rpx;\r\n}\r\n\r\n.search-btn {\r\n  width: 160rpx;\r\n  height: 80rpx;\r\n  line-height: 80rpx;\r\n  text-align: center;\r\n  color: #fff;\r\n  background-color: #409eff;\r\n  border: none;\r\n  border-radius: 8rpx;\r\n  font-size: 28rpx;\r\n}\r\n\r\n.result-box {\r\n  margin-top: 30rpx;\r\n  padding: 20rpx;\r\n  background-color: #fff;\r\n  border-radius: 12rpx;\r\n}\r\n\r\n.result-image {\r\n  width: 100%;\r\n  border-radius: 12rpx;\r\n  box-shadow: 0 2rpx 12rpx rgba(0, 0, 0, 0.1);\r\n}\r\n\r\n.action-btn {\r\n  margin-top: 20rpx;\r\n  width: 100%;\r\n  height: 80rpx;\r\n  line-height: 80rpx;\r\n  text-align: center;\r\n  color: #fff;\r\n  background-color: #409eff;\r\n  border: none;\r\n  border-radius: 8rpx;\r\n  font-size: 28rpx;\r\n}\r\n\r\n.save-btn {\r\n  background-color: #409eff;\r\n}\r\n\r\n.tip-text {\r\n  font-size: 24rpx;\r\n  color: #999;\r\n  padding: 20rpx;\r\n  line-height: 1.4;\r\n}\r\n</style>\r\n","import MiniProgramPage from 'D:/por/cursor/xcx/freeyunpan/pages/book/index.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","uni","getBookRecommend","uniCloud","onShareAppMessage","onShareTimeline"],"mappings":"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"}